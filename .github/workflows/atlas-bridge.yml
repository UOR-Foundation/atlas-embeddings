name: Atlas Bridge CI (v0.4)

on:
  push:
    branches: [ main, develop, copilot/** ]
    paths:
      - 'atlas/**'
      - 'tests/test*.c'
      - 'atlas/bindings/python/atlas_bridge/**'
      - '.github/workflows/atlas-bridge.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'atlas/**'
      - 'tests/test*.c'
      - 'atlas/bindings/python/atlas_bridge/**'

jobs:
  build-and-test:
    name: Build and Test Atlas Bridge
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: macos-latest
            compiler: gcc
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up build tools
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y build-essential valgrind
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install gcc
        fi
    
    - name: Build atlas library (legacy)
      working-directory: atlas
      env:
        CC: ${{ matrix.compiler }}
      run: |
        # Build legacy atlas_bridge library
        mkdir -p lib
        $CC -c -fPIC -Iinclude \
          src/atlas_bridge.c \
          src/linalg_util.c \
          src/e_group.c \
          src/twirl.c \
          src/projectors.c \
          src/co1_gates.c \
          src/diagnostics.c
        
        # Create shared library
        if [ "$RUNNER_OS" == "Linux" ]; then
          $CC -shared -o lib/libatlas_bridge.so *.o -lm
        elif [ "$RUNNER_OS" == "macOS" ]; then
          $CC -dynamiclib -o lib/libatlas_bridge.dylib *.o -lm
        fi
        
        # Clean up object files
        rm *.o
    
    - name: Build atlas_bridge_ctx library (v0.4)
      working-directory: atlas
      env:
        CC: ${{ matrix.compiler }}
      run: |
        # Build v0.4 context API library with AVX2 support
        # Enable AVX2 on x86_64 Linux (will fallback gracefully on other platforms)
        if [ "$RUNNER_OS" == "Linux" ]; then
          CFLAGS="-mavx2"
        else
          CFLAGS=""
        fi
        
        $CC -c -fPIC $CFLAGS -Iinclude src/atlas_bridge_ctx.c
        
        # Create shared library
        if [ "$RUNNER_OS" == "Linux" ]; then
          $CC -shared -o lib/libatlas_bridge_ctx.so atlas_bridge_ctx.o -lm
        elif [ "$RUNNER_OS" == "macOS" ]; then
          $CC -dynamiclib -o lib/libatlas_bridge_ctx.dylib atlas_bridge_ctx.o -lm
        fi
        
        rm atlas_bridge_ctx.o
    
    - name: Build test executables (legacy)
      env:
        CC: ${{ matrix.compiler }}
      run: |
        # Compile legacy test programs
        $CC -o test_explosion tests/test_explosion.c \
          atlas/src/atlas_bridge.c \
          atlas/src/linalg_util.c \
          atlas/src/e_group.c \
          atlas/src/twirl.c \
          atlas/src/projectors.c \
          atlas/src/co1_gates.c \
          atlas/src/diagnostics.c \
          -Iatlas/include -lm
        
        $CC -o test_projectors tests/test_projectors.c \
          atlas/src/atlas_bridge.c \
          atlas/src/linalg_util.c \
          atlas/src/e_group.c \
          atlas/src/twirl.c \
          atlas/src/projectors.c \
          atlas/src/co1_gates.c \
          atlas/src/diagnostics.c \
          -Iatlas/include -lm
        
        $CC -o test_commutant tests/test_commutant.c \
          atlas/src/atlas_bridge.c \
          atlas/src/linalg_util.c \
          atlas/src/e_group.c \
          atlas/src/twirl.c \
          atlas/src/projectors.c \
          atlas/src/co1_gates.c \
          atlas/src/diagnostics.c \
          -Iatlas/include -lm
    
    - name: Build Context API tests (v0.4)
      env:
        CC: ${{ matrix.compiler }}
      run: |
        # Build v0.2 compatibility tests
        $CC -o tests_ctx tests/tests_ctx.c \
          atlas/src/atlas_bridge_ctx.c \
          -Iatlas/include -lm
        
        # Build v0.3 extended tests
        $CC -o tests_ctx_v03 tests/tests_ctx_v03.c \
          atlas/src/atlas_bridge_ctx.c \
          -Iatlas/include -lm
        
        # Build v0.4 extended tests (with AVX2 on Linux)
        if [ "$RUNNER_OS" == "Linux" ]; then
          CFLAGS="-mavx2"
        else
          CFLAGS=""
        fi
        $CC $CFLAGS -o tests_ctx_v04 tests/tests_ctx_v04.c \
          atlas/src/atlas_bridge_ctx.c \
          -Iatlas/include -lm
        
        # Build spinlift demo
        $CC -o test_spinlift_demo tests/test_spinlift_demo.c \
          atlas/src/atlas_bridge_ctx.c \
          -Iatlas/include -lm
    
    - name: Run legacy C tests
      run: |
        echo "Running test_explosion..."
        ./test_explosion
        
        echo "Running test_projectors..."
        ./test_projectors
        
        echo "Running test_commutant..."
        ./test_commutant
    
    - name: Run Context API tests (v0.2 compatibility)
      run: |
        echo "Running v0.2 compatibility tests..."
        ./tests_ctx
    
    - name: Run Context API tests (v0.3 extended)
      run: |
        echo "Running v0.3 extended tests..."
        ./tests_ctx_v03
    
    - name: Run Context API tests (v0.4 extended)
      run: |
        echo "Running v0.4 extended tests..."
        ./tests_ctx_v04
    
    - name: Run spinlift demo
      run: |
        echo "Running spinlift demo..."
        ./test_spinlift_demo
    
    - name: Generate JSON certificate (v0.4)
      run: |
        # Create test certificate using v0.4 API
        cat > /tmp/cert_generator.c << 'EOF'
#include "atlas/include/atlas_bridge_ctx.h"
#include <stdio.h>
#include <stdlib.h>

int main() {
    AtlasContextConfig cfg;
    atlas_ctx_config_default(&cfg);
    cfg.flags = ATLAS_CTX_ENABLE_TWIRL | ATLAS_CTX_ENABLE_P_CLASS | 
                ATLAS_CTX_ENABLE_P_299 | ATLAS_CTX_ENABLE_CO1 | ATLAS_CTX_USE_AVX2;
    
    AtlasBridgeContext* ctx = atlas_ctx_new(&cfg);
    
    // Set example lift forms
    atlas_ctx_set_lift_forms_hex(ctx, "deadbeef0123456789abcdef", 24);
    
    // Perform some operations
    double* state = malloc(12288 * sizeof(double));
    for (int i = 0; i < 12288; i++) state[i] = (double)i / 12288.0;
    
    atlas_ctx_apply_p_class(ctx, state);
    atlas_ctx_check_p_class_idempotency(ctx, state);
    atlas_ctx_apply_p_299(ctx, state);
    atlas_ctx_check_p_299_idempotency(ctx, state);
    atlas_ctx_probe_commutant(ctx, state, 1);
    
    // Emit certificate
    atlas_ctx_emit_certificate(ctx, "bridge_cert.json", "ci_test");
    
    printf("Certificate generated: bridge_cert.json\n");
    
    free(state);
    atlas_ctx_free(ctx);
    return 0;
}
EOF
        
        # Compile with AVX2 on Linux
        if [ "$RUNNER_OS" == "Linux" ]; then
          CFLAGS="-mavx2"
        else
          CFLAGS=""
        fi
        
        ${{ matrix.compiler }} $CFLAGS -o cert_generator /tmp/cert_generator.c \
          atlas/src/atlas_bridge_ctx.c \
          -Iatlas/include -lm
        
        ./cert_generator
        
        echo "Certificate contents:"
        cat bridge_cert.json
    
    - name: Upload JSON certificate artifact (v0.4)
      uses: actions/upload-artifact@v3
      with:
        name: bridge-certificate-${{ matrix.os }}-${{ matrix.compiler }}
        path: bridge_cert.json
        retention-days: 30
    
    - name: Memory check (Linux only)
      if: runner.os == 'Linux' && matrix.compiler == 'gcc'
      run: |
        echo "Running memory checks with valgrind..."
        valgrind --leak-check=full --error-exitcode=1 ./test_explosion
        valgrind --leak-check=full --error-exitcode=1 ./test_projectors
        valgrind --leak-check=full --error-exitcode=1 ./test_commutant
        valgrind --leak-check=full --error-exitcode=1 ./tests_ctx
        valgrind --leak-check=full --error-exitcode=1 ./tests_ctx_v03
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Test Python bindings
      run: |
        # Make library discoverable
        if [ "$RUNNER_OS" == "Linux" ]; then
          export LD_LIBRARY_PATH="${PWD}/atlas/lib:$LD_LIBRARY_PATH"
        elif [ "$RUNNER_OS" == "macOS" ]; then
          export DYLD_LIBRARY_PATH="${PWD}/atlas/lib:$DYLD_LIBRARY_PATH"
        fi
        
        # Run Python examples (if they exist)
        if [ -f atlas/bindings/python/atlas_bridge/examples/run_all.py ]; then
          python3 atlas/bindings/python/atlas_bridge/examples/run_all.py
        else
          echo "Python examples not found, skipping"
        fi
    
    - name: Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-outputs-${{ matrix.os }}-${{ matrix.compiler }}
        path: |
          /tmp/test_leakage.json
          /tmp/atlas_leakage_cert.json
          /tmp/test_bridge_cert.json
          bridge_cert.json

  lint:
    name: Lint C Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format
    
    - name: Check code formatting
      run: |
        # For now, just check that files exist
        find atlas/src -name "*.c" -o -name "*.h" | while read f; do
          echo "Checking $f"
        done
    
    - name: Static analysis with cppcheck
      run: |
        sudo apt-get install -y cppcheck
        cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          atlas/src/ tests/*.c
